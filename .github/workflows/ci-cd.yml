name: ğŸš¢ Deployment Pipeline

on:
  push:
    tags:
      - "*"
    branches:
      - main
  workflow_dispatch:

jobs:
  detect-changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      serveur_changed: ${{ steps.changes.outputs.serveur }}
      app_changed: ${{ steps.changes.outputs.app }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ”„ Detect file changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            serveur:
              - 'serveur/**'
            app:
              - 'app/**'

  build-serveur:
    name: ğŸš€ Build & Deploy Server
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.serveur_changed == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/') }}
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Š Deployment details
        run: echo "Pipeline run by ${GITHUB_EVENT_NAME} on ${GITHUB_REF_TYPE} ${{github.ref_name}}"

      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22.1.0

      - name: ğŸ“š Install dependencies
        working-directory: ./serveur
        run: npm ci

      - name: ğŸ§ª Run tests
        working-directory: ./serveur
        run: npm test

      - name: ğŸ³ Setup Docker Image
        uses: docker/setup-buildx-action@v2
        timeout-minutes: 12

      - name: ğŸ” Check Docker installation
        run: docker --version

      - name: ğŸ“ Create Docker daemon.json (if necessary)
        run: |
          if [ ! -f /etc/docker/daemon.json ]; then
            echo '{}' | sudo tee /etc/docker/daemon.json
          fi

      - name: ğŸ·ï¸ Extract version from package.json
        id: extract_version
        working-directory: ./serveur
        run: echo "version=$(jq -r '.version' package.json)" >> $GITHUB_OUTPUT

      - name: ğŸ—ï¸ Build Docker image
        id: build_image_serveur
        working-directory: ./serveur
        run: docker build -t $SERVER_CONTAINER_IMG_NAME .
        env:
          SERVER_CONTAINER_IMG_NAME: ${{ secrets.SERVER_CONTAINER_IMG_NAME }}

      - name: ğŸ”‘ Login to Docker Hub
        run: docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ“¤ Push Docker image
        run: docker push $SERVER_CONTAINER_IMG_NAME
        env:
          SERVER_CONTAINER_IMG_NAME: ${{ secrets.SERVER_CONTAINER_IMG_NAME }}

      - name: ğŸŒŠ Setup DigitalOcean
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: âš“ Connect to Kubernetes cluster
        run: doctl kubernetes cluster kubeconfig save $K8S_CLUSTER_NAME
        env:
          K8S_CLUSTER_NAME: ${{ secrets.K8S_CLUSTER_NAME }}

      - name: ğŸ”„ Deploy to Kubernetes
        run: kubectl rollout restart deployment $K8S_SERVER_DEPLOYMENT_NAME -n nsenv
        env:
          K8S_SERVER_DEPLOYMENT_NAME: ${{ secrets.K8S_SERVER_DEPLOYMENT_NAME }}

  build-client:
    name: ğŸš€ Build & Deploy Client
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.app_changed == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/') }}
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Š Deployment details
        run: echo "Pipeline run by ${GITHUB_EVENT_NAME} on ${GITHUB_REF_TYPE} ${{github.ref_name}}"

      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: ğŸ³ Setup Docker
        uses: docker/setup-buildx-action@v2
        timeout-minutes: 12

      - name: ğŸ·ï¸ Extract version from package.json
        id: extract_version
        working-directory: ./app
        run: echo "version=$(jq -r '.version' package.json)" >> $GITHUB_OUTPUT

      - name: ğŸ—ï¸ Build Docker image
        id: build_image_client
        working-directory: ./app
        run: docker build -t $CLIENT_CONTAINER_IMG_NAME .
        env:
          CLIENT_CONTAINER_IMG_NAME: ${{ secrets.CLIENT_CONTAINER_IMG_NAME }}

      - name: ğŸ”‘ Login to Docker Hub
        run: docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ“¤ Push Docker image
        run: docker push $CLIENT_CONTAINER_IMG_NAME
        env:
          CLIENT_CONTAINER_IMG_NAME: ${{ secrets.CLIENT_CONTAINER_IMG_NAME }}

      - name: ğŸŒŠ Setup DigitalOcean
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: âš“ Connect to Kubernetes cluster
        run: doctl kubernetes cluster kubeconfig save $K8S_CLUSTER_NAME
        env:
          K8S_CLUSTER_NAME: ${{ secrets.K8S_CLUSTER_NAME }}

      - name: ğŸ”„ Deploy to Kubernetes
        run: kubectl rollout restart deployment $K8S_CLIENT_DEPLOYMENT_NAME -n nsenv
        env:
          K8S_CLIENT_DEPLOYMENT_NAME: ${{ secrets.K8S_CLIENT_DEPLOYMENT_NAME }}

  # e2e-tests:
  #   name: ğŸ§ª Run End-to-End Tests
  #   needs: [build-serveur, build-client]
  #   if: ${{ always() && (needs.build-serveur.result == 'success' || needs.build-client.result == 'success') }}
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: ğŸ“¥ Checkout
  #       uses: actions/checkout@v3

  #     - name: ğŸ“¦ Setup Node.js
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: 22.1.0

  #     - name: â³ Wait for deployments
  #       run: sleep 60

  #     - name: ğŸ“š Install Cypress and dependencies
  #       working-directory: ./e2e
  #       run: npm ci

  #     - name: ğŸ“š Install dependencies
  #       working-directory: ./app
  #       run: yarn install

  #     - name: ğŸ§ª Run E2E tests
  #       working-directory: ./e2e
  #       run: yarn test
  #       env:
  #         CYPRESS_BASE_URL: ${{ secrets.E2E_TEST_URL }}
